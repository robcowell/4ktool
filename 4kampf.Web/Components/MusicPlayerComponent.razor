@using _4kampf.Web.Services
@inject WebAudioService WebAudio
@rendermode InteractiveServer
@implements IAsyncDisposable

<div class="music-player">
    <div class="player-controls">
        <button class="btn-play" @onclick="PlayPause">
            @if (isPlaying)
            {
                <span>‚è∏</span>
            }
            else
            {
                <span>‚ñ∂</span>
            }
        </button>
        <button class="btn-rewind" @onclick="Rewind">‚èÆ</button>
        <button class="btn-mute" @onclick="ToggleMute">üîä</button>
    </div>
    
    <div class="player-info">
        <div class="time-display">@FormatTime(currentTime) / @FormatTime(duration)</div>
        <div class="fps-display">@fps fps</div>
        @if (!string.IsNullOrEmpty(bpm))
        {
            <div class="bpm-display">@bpm bpm</div>
        }
    </div>
    
    <div class="player-transport">
        <input type="range" class="transport-slider" min="0" max="100" 
               value="@transportValue" @onchange="OnTransportChanged" />
    </div>
    
    <div class="player-volume">
        <input type="range" class="volume-slider" min="0" max="100" 
               value="@volumeValue" @onchange="OnVolumeChanged" />
    </div>
    
    @if (showVU)
    {
        <div class="vu-meter">
            @for (int i = 0; i < vuLevels.Length; i++)
            {
                <div class="vu-bar" style="height: @(vuLevels[i] * 100)%"></div>
            }
        </div>
    }
</div>

@code {
    private bool isPlaying = false;
    private bool isMuted = false;
    private double currentTime = 0;
    private double duration = 0;
    private int transportValue = 0;
    private int volumeValue = 100;
    private string fps = "60 fps";
    private string bpm = "";
    private bool showVU = false;
    private float[] vuLevels = new float[16];
    
    private System.Threading.Timer? updateTimer;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                updateTimer = new System.Threading.Timer(async _ => 
                {
                    try
                    {
                        await UpdatePlayerState();
                    }
                    catch (Exception ex)
                    {
                        // Log error but don't crash
                        Console.WriteLine($"Error updating player state: {ex.Message}");
                    }
                }, null, TimeSpan.Zero, TimeSpan.FromMilliseconds(100));
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing music player: {ex.Message}");
            }
        }
    }

    private async Task PlayPause()
    {
        if (isPlaying)
        {
            await WebAudio.PauseAsync();
        }
        else
        {
            await WebAudio.PlayAsync();
        }
        isPlaying = !isPlaying;
    }

    private async Task Rewind()
    {
        await WebAudio.SetPositionAsync(0);
    }

    private async Task ToggleMute()
    {
        isMuted = !isMuted;
        await WebAudio.SetVolumeAsync(isMuted ? 0 : volumeValue / 100.0);
    }

    private async Task OnTransportChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            transportValue = value;
            double newTime = (value / 100.0) * duration;
            await WebAudio.SetPositionAsync(newTime);
        }
    }

    private async Task OnVolumeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            volumeValue = value;
            await WebAudio.SetVolumeAsync(value / 100.0);
        }
    }

    private async Task UpdatePlayerState()
    {
        try
        {
            currentTime = await WebAudio.GetPositionAsync();
            duration = await WebAudio.GetDurationAsync();
            
            if (duration > 0)
            {
                transportValue = (int)((currentTime / duration) * 100);
            }
            
            // Update VU levels if available
            var envelopeData = await WebAudio.GetEnvelopeDataAsync(16);
            if (envelopeData != null)
            {
                vuLevels = envelopeData;
                showVU = true;
            }
            
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            // Silently handle errors in timer callback
            Console.WriteLine($"Error in UpdatePlayerState: {ex.Message}");
        }
    }

    private string FormatTime(double seconds)
    {
        int mins = (int)(seconds / 60);
        int secs = (int)(seconds % 60);
        return $"{mins:D2}:{secs:D2}";
    }

    public async Task LoadAudio(string audioUrl)
    {
        duration = await WebAudio.LoadAudioAsync(audioUrl);
    }

    public async ValueTask DisposeAsync()
    {
        updateTimer?.Dispose();
        await Task.CompletedTask;
    }
}

<style>
    .music-player {
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: #2d2d30;
        border-top: 1px solid #3e3e3e;
        gap: 10px;
    }

    .player-controls {
        display: flex;
        gap: 5px;
    }

    .btn-play, .btn-rewind, .btn-mute {
        background-color: #3e3e3e;
        border: none;
        color: #d4d4d4;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 4px;
    }

    .btn-play:hover, .btn-rewind:hover, .btn-mute:hover {
        background-color: #4e4e4e;
    }

    .player-info {
        display: flex;
        flex-direction: column;
        min-width: 150px;
        color: #d4d4d4;
        font-size: 12px;
    }

    .time-display {
        font-size: 20px;
        font-weight: bold;
    }

    .player-transport {
        flex: 1;
    }

    .transport-slider, .volume-slider {
        width: 100%;
    }

    .player-volume {
        width: 150px;
    }

    .vu-meter {
        display: flex;
        gap: 2px;
        height: 30px;
        align-items: flex-end;
    }

    .vu-bar {
        width: 4px;
        background-color: #4CAF50;
        min-height: 2px;
    }
</style>

